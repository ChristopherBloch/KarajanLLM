{% extends "base.html" %}
{% block title %}Heartbeat - Aria Blue{% endblock %}

{% block page_title %}üíì Heartbeat{% endblock %}
{% block page_subtitle %}Scheduled jobs and system pulse{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="triggerTick()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="5 3 19 12 5 21 5 3"/>
    </svg>
    Manual Tick
</button>
{% endblock %}

{% block content %}
<!-- Heartbeat Status Overview -->
<div class="heartbeat-hero">
    <div class="pulse-indicator" id="pulseIndicator">
        <div class="pulse-ring"></div>
        <div class="pulse-core">üíì</div>
    </div>
    <div class="heartbeat-status">
        <h2 id="heartbeatStatus">Checking...</h2>
        <p id="lastTickTime">Last tick: --</p>
    </div>
</div>

<!-- Stats Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üîÑ</div>
        <div class="stat-info">
            <span class="stat-value" id="totalJobs">10</span>
            <span class="stat-label">Scheduled Jobs</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
            <span class="stat-value" id="successfulRuns">-</span>
            <span class="stat-label">Successful (24h)</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-info">
            <span class="stat-value" id="failedRuns">-</span>
            <span class="stat-label">Failed (24h)</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚è∞</div>
        <div class="stat-info">
            <span class="stat-value" id="nextJob">-</span>
            <span class="stat-label">Next Job In</span>
        </div>
    </div>
</div>

<!-- Scheduled Jobs Grid -->
<section class="section">
    <div class="section-header">
        <h2>‚è∞ Scheduled Jobs</h2>
        <p>Aria's recurring tasks and their schedules</p>
    </div>
    <div class="jobs-grid" id="jobsGrid">
        <!-- Jobs will be rendered here -->
    </div>
</section>

<!-- Recent Executions -->
<section class="section">
    <div class="section-header">
        <h2>üìã Recent Executions</h2>
        <div class="section-actions">
            <select id="logFilter" onchange="filterLogs()">
                <option value="all">All Jobs</option>
                <option value="work_cycle">Work Cycle</option>
                <option value="hourly_goal_check">Hourly Goal Check</option>
                <option value="six_hour_review">Six Hour Review</option>
                <option value="moltbook_post">Moltbook Post</option>
                <option value="daily_reflection">Daily Reflection</option>
            </select>
        </div>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Job Name</th>
                    <th>Status</th>
                    <th>Details</th>
                    <th>Executed At</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody id="logsTable">
                <tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr>
            </tbody>
        </table>
    </div>
</section>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>
{% endblock %}

{% block extra_css %}
<style>
/* Heartbeat Hero */
.heartbeat-hero {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xl);
    padding: var(--space-2xl);
    background: linear-gradient(180deg, var(--bg-tertiary) 0%, transparent 100%);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-xl);
}

.pulse-indicator {
    position: relative;
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pulse-ring {
    position: absolute;
    inset: 0;
    border: 3px solid var(--accent-primary);
    border-radius: 50%;
    animation: pulse-ring 2s ease-out infinite;
}

.pulse-ring::before {
    content: '';
    position: absolute;
    inset: -10px;
    border: 2px solid var(--accent-primary);
    border-radius: 50%;
    opacity: 0.5;
    animation: pulse-ring 2s ease-out infinite 0.5s;
}

@keyframes pulse-ring {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(1.5);
        opacity: 0;
    }
}

.pulse-core {
    font-size: 3rem;
    animation: pulse-beat 1s ease-in-out infinite;
}

@keyframes pulse-beat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.pulse-indicator.offline .pulse-ring,
.pulse-indicator.offline .pulse-ring::before {
    border-color: var(--danger);
    animation: none;
}

.pulse-indicator.offline .pulse-core {
    animation: none;
    opacity: 0.5;
}

.heartbeat-status {
    text-align: left;
}

.heartbeat-status h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.heartbeat-status p {
    color: var(--text-muted);
    font-size: 0.9rem;
}

/* Section */
.section {
    margin-bottom: var(--space-xl);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
    gap: var(--space-md);
}

.section-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
}

.section-header p {
    color: var(--text-muted);
    font-size: 0.9rem;
    width: 100%;
}

.section-actions select {
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.85rem;
    cursor: pointer;
}

/* Jobs Grid */
.jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-lg);
}

/* Job Card */
.job-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
}

.job-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-gradient);
    transform: scaleX(0);
    transition: transform var(--transition-base);
}

.job-card:hover {
    border-color: var(--border-accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.job-card:hover::before {
    transform: scaleX(1);
}

.job-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

.job-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    font-size: 1.5rem;
    flex-shrink: 0;
}

.job-info {
    flex: 1;
}

.job-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.job-schedule {
    font-size: 0.8rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
}

.job-status {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-full);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.job-status.active {
    background: var(--success-bg);
    color: var(--success);
}

.job-status.idle {
    background: var(--info-bg);
    color: var(--info);
}

.job-status.error {
    background: var(--danger-bg);
    color: var(--danger);
}

.job-description {
    color: var(--text-secondary);
    font-size: 0.85rem;
    line-height: 1.5;
    margin-bottom: var(--space-md);
}

.job-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
    font-size: 0.8rem;
}

.job-meta-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.job-meta-label {
    color: var(--text-dim);
    font-size: 0.7rem;
    text-transform: uppercase;
}

.job-meta-value {
    color: var(--text-secondary);
}

.job-meta-value.next {
    color: var(--accent-primary);
    font-weight: 600;
}

/* Table Styles */
.table-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.log-status {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

.log-status.success {
    background: var(--success-bg);
    color: var(--success);
}

.log-status.error {
    background: var(--danger-bg);
    color: var(--danger);
}

.log-status.running {
    background: var(--info-bg);
    color: var(--info);
}

.log-details {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text-muted);
    font-size: 0.85rem;
}

/* Toast */
.toast {
    position: fixed;
    bottom: var(--space-xl);
    right: var(--space-xl);
    padding: var(--space-md) var(--space-lg);
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: 0.9rem;
    box-shadow: var(--shadow-xl);
    transform: translateY(100px);
    opacity: 0;
    transition: all var(--transition-base);
    z-index: var(--z-tooltip);
}

.toast.show {
    transform: translateY(0);
    opacity: 1;
}

.toast.success {
    border-color: var(--success);
}

.toast.error {
    border-color: var(--danger);
}

/* Loading */
.loading {
    text-align: center;
    padding: var(--space-xl);
    color: var(--text-muted);
}

@media (max-width: 640px) {
    .heartbeat-hero {
        flex-direction: column;
        text-align: center;
    }
    
    .heartbeat-status {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script data-page-script>
// Scheduled Jobs Configuration
const scheduledJobs = [
    {
        id: 'work_cycle',
        name: 'Work Cycle',
        icon: '‚ö°',
        schedule: '*/5 * * * *',
        description: 'Productivity pulse - pick a goal, do one action, log progress.',
        frequency: 'Every 5 minutes'
    },
    {
        id: 'hourly_goal_check',
        name: 'Hourly Goal Check',
        icon: 'üéØ',
        schedule: '0 * * * *',
        description: 'Check and complete any goals marked for the current hour.',
        frequency: 'Every hour'
    },
    {
        id: 'six_hour_review',
        name: 'Six Hour Review',
        icon: 'üìä',
        schedule: '0 */6 * * *',
        description: 'Analyze activity patterns and adjust priorities.',
        frequency: 'Every 6 hours'
    },
    {
        id: 'moltbook_post',
        name: 'Moltbook Post',
        icon: 'ü¶û',
        schedule: '0 */6 * * *',
        description: 'Create and publish a thoughtful post to Moltbook.',
        frequency: 'Every 6 hours'
    },
    {
        id: 'subagent_delegation',
        name: 'Sub-agent Delegation',
        icon: 'ü§ñ',
        schedule: '0 */6 * * *',
        description: 'Delegate complex tasks to specialized sub-agents.',
        frequency: 'Every 6 hours'
    },
    {
        id: 'daily_reflection',
        name: 'Daily Reflection',
        icon: 'üåô',
        schedule: '0 23 * * *',
        description: 'End-of-day summary and accomplishment review.',
        frequency: 'Daily at 11 PM'
    },
    {
        id: 'morning_checkin',
        name: 'Morning Check-in',
        icon: '‚òÄÔ∏è',
        schedule: '0 8 * * *',
        description: 'Start the day with status check and goal planning.',
        frequency: 'Daily at 8 AM'
    },
    {
        id: 'weekly_summary',
        name: 'Weekly Summary',
        icon: 'üìà',
        schedule: '0 18 * * 0',
        description: 'Weekly progress report and goal adjustment.',
        frequency: 'Sunday 6 PM'
    },
    {
        id: 'social_presence',
        name: 'Social Presence',
        icon: 'üí¨',
        schedule: '0 */4 * * *',
        description: 'Check Moltbook notifications and engage.',
        frequency: 'Every 4 hours'
    },
    {
        id: 'db_maintenance',
        name: 'DB Maintenance',
        icon: 'üóÑÔ∏è',
        schedule: '0 3 * * *',
        description: 'VACUUM ANALYZE and clean old data.',
        frequency: 'Daily at 3 AM'
    }
];

let allLogs = [];

async function loadHeartbeatData() {
    await Promise.all([
        loadScheduleStatus(),
        loadHeartbeatLogs()
    ]);
}

async function loadScheduleStatus() {
    try {
        const response = await fetch(`${window.ARIA_API_BASE_URL}/schedule`);
        const data = await response.json();
        
        document.getElementById('heartbeatStatus').textContent = 'System Active';
        document.getElementById('pulseIndicator').classList.remove('offline');
        
        if (data.last_tick) {
            const lastTick = new Date(data.last_tick);
            document.getElementById('lastTickTime').textContent = `Last tick: ${formatRelativeTime(lastTick)}`;
        }
    } catch (error) {
        document.getElementById('heartbeatStatus').textContent = 'System Offline';
        document.getElementById('pulseIndicator').classList.add('offline');
        document.getElementById('lastTickTime').textContent = 'Unable to reach scheduler';
    }
    
    renderJobsGrid();
}

async function loadHeartbeatLogs() {
    try {
        const response = await fetch(`${window.ARIA_API_BASE_URL}/records?table=heartbeat_log&limit=100`);
        const data = await response.json();
        allLogs = data.records || data || [];
        
        updateLogStats();
        filterLogs();
    } catch (error) {
        document.getElementById('logsTable').innerHTML = `
            <tr><td colspan="5" class="empty-state">Error loading logs: ${error.message}</td></tr>
        `;
    }
}

function updateLogStats() {
    const now = new Date();
    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    const recentLogs = allLogs.filter(log => {
        const logTime = new Date(log.executed_at || log.created_at);
        return logTime >= oneDayAgo;
    });
    
    const successful = recentLogs.filter(log => log.status === 'success' || log.status === 'completed').length;
    const failed = recentLogs.filter(log => log.status === 'error' || log.status === 'failed').length;
    
    document.getElementById('successfulRuns').textContent = successful;
    document.getElementById('failedRuns').textContent = failed;
    
    // Calculate next job (simplified - based on work_cycle every 5 min)
    const minutes = now.getMinutes();
    const nextTickMin = Math.ceil(minutes / 5) * 5 - minutes;
    document.getElementById('nextJob').textContent = nextTickMin === 0 ? 'Now' : `${nextTickMin}m`;
}

function renderJobsGrid() {
    const container = document.getElementById('jobsGrid');
    
    container.innerHTML = scheduledJobs.map(job => {
        // Find last execution for this job
        const lastLog = allLogs.find(log => log.job_name === job.id);
        const lastRun = lastLog ? formatRelativeTime(new Date(lastLog.executed_at || lastLog.created_at)) : 'Never';
        const status = lastLog?.status === 'error' ? 'error' : 'active';
        
        return `
            <div class="job-card">
                <div class="job-header">
                    <div class="job-icon">${job.icon}</div>
                    <div class="job-info">
                        <div class="job-name">${job.name}</div>
                        <div class="job-schedule">${job.schedule}</div>
                    </div>
                    <span class="job-status ${status}">${status}</span>
                </div>
                <p class="job-description">${job.description}</p>
                <div class="job-meta">
                    <div class="job-meta-item">
                        <span class="job-meta-label">Frequency</span>
                        <span class="job-meta-value">${job.frequency}</span>
                    </div>
                    <div class="job-meta-item">
                        <span class="job-meta-label">Last Run</span>
                        <span class="job-meta-value">${lastRun}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function filterLogs() {
    const filter = document.getElementById('logFilter').value;
    const tbody = document.getElementById('logsTable');
    
    let filtered = allLogs;
    if (filter !== 'all') {
        filtered = allLogs.filter(log => log.job_name === filter);
    }
    
    // Sort by execution time descending
    filtered.sort((a, b) => {
        const timeA = new Date(a.executed_at || a.created_at);
        const timeB = new Date(b.executed_at || b.created_at);
        return timeB - timeA;
    });
    
    // Limit to 50 most recent
    filtered = filtered.slice(0, 50);
    
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="5" class="empty-state">No execution logs found</td></tr>
        `;
        return;
    }
    
    tbody.innerHTML = filtered.map(log => {
        const executedAt = log.executed_at || log.created_at;
        const status = log.status || 'unknown';
        const statusClass = status === 'success' || status === 'completed' ? 'success' : 
                           status === 'error' || status === 'failed' ? 'error' : 'running';
        
        const jobInfo = scheduledJobs.find(j => j.id === log.job_name) || { icon: '‚ùì', name: log.job_name };
        
        return `
            <tr>
                <td>
                    <span style="margin-right: 8px;">${jobInfo.icon}</span>
                    ${jobInfo.name || log.job_name}
                </td>
                <td><span class="log-status ${statusClass}">${status}</span></td>
                <td class="log-details" title="${escapeHtml(log.details || '')}">${escapeHtml(log.details || '-')}</td>
                <td>${executedAt ? formatRelativeTime(new Date(executedAt)) : '-'}</td>
                <td>${log.duration ? `${log.duration}ms` : '-'}</td>
            </tr>
        `;
    }).join('');
}

async function triggerTick() {
    try {
        const response = await fetch(`${window.ARIA_API_BASE_URL}/schedule/tick`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showToast('‚ö° Manual tick triggered!', 'success');
            // Reload data after a short delay
            setTimeout(loadHeartbeatData, 2000);
        } else {
            throw new Error('Failed to trigger tick');
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

function formatRelativeTime(date) {
    const now = new Date();
    const diff = now - date;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (seconds < 60) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Auto-refresh every 60 seconds
setInterval(loadHeartbeatData, 60000);

// Initialize
document.addEventListener('DOMContentLoaded', loadHeartbeatData);
</script>
{% endblock %}
