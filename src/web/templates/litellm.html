{% extends "base.html" %}
{% block title %}LiteLLM - Aria{% endblock %}

{% block extra_css %}
<style>
.litellm-container {
    max-width: 1200px;
    margin: 0 auto;
}

.status-overview {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
}

@media (max-width: 768px) {
    .status-overview { grid-template-columns: 1fr; }
}

.status-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    transition: all var(--transition-base);
}

.status-card:hover {
    border-color: var(--border-accent);
    transform: translateY(-2px);
}

.status-icon {
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    font-size: 1.5rem;
}

.status-icon.online { background: var(--success-bg); }
.status-icon.offline { background: var(--danger-bg); }
.status-icon.pending { background: var(--warning-bg); }

.status-info h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.status-info p {
    font-size: 0.875rem;
    color: var(--text-muted);
}

/* Indicator dots */
.indicator-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: var(--space-xs);
}

.indicator-dot.online {
    background: var(--success);
    box-shadow: 0 0 10px var(--success);
    animation: pulse 2s infinite;
}

.indicator-dot.offline {
    background: var(--danger);
}

.indicator-dot.pending {
    background: var(--warning);
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Models Table */
.models-section {
    margin-bottom: var(--space-xl);
}

.table-container {
    overflow-x: auto;
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-subtle);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--border-subtle);
}

.data-table th {
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--text-muted);
    background: var(--bg-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.data-table tbody tr {
    transition: background var(--transition-fast);
}

.data-table tbody tr:hover {
    background: var(--bg-hover);
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.model-name {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: var(--accent-primary);
    font-weight: 500;
}

.provider-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

.provider-openai { background: rgba(16, 163, 127, 0.15); color: #10a37f; }
.provider-anthropic { background: rgba(204, 133, 79, 0.15); color: #cc854f; }
.provider-google { background: rgba(66, 133, 244, 0.15); color: #4285f4; }
.provider-local { background: rgba(139, 92, 246, 0.15); color: var(--accent-secondary); }
.provider-kimi { background: rgba(255, 107, 107, 0.15); color: #ff6b6b; }
.provider-other { background: var(--bg-tertiary); color: var(--text-muted); }

.status-badge {
    padding: 4px 10px;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

.status-badge.available {
    background: var(--success-bg);
    color: var(--success);
}

/* Model Cards Grid */
.model-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-md);
}

.model-card {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    border: 1px solid var(--border-subtle);
    transition: all var(--transition-fast);
}

.model-card:hover {
    border-color: var(--accent-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.model-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-sm);
}

.model-card-name {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    word-break: break-word;
}

.model-card-stats {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.model-card-stat {
    display: flex;
    justify-content: space-between;
}

/* API Endpoints */
.endpoints-section {
    margin-top: var(--space-xl);
}

.endpoints-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.endpoint-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.endpoint-item.highlight {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
    border-color: var(--accent-primary);
}

.endpoint-url {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--accent-primary);
    background: var(--bg-tertiary);
    padding: 6px 12px;
    border-radius: var(--radius-sm);
}

.endpoint-desc {
    color: var(--text-secondary);
    font-size: 0.875rem;
    flex: 1;
}

/* Skeleton loading */
.skeleton {
    background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: var(--radius-sm);
}

.skeleton-text {
    height: 1rem;
    width: 100%;
}

.skeleton-row td {
    padding: var(--space-md);
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: var(--space-2xl);
    color: var(--text-muted);
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: var(--space-md);
}

/* Section header */
.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

/* Pricing cells */
.price-cell {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.price-free {
    color: var(--success);
    font-weight: 600;
    font-size: 0.75rem;
    background: var(--success-bg);
    padding: 2px 8px;
    border-radius: var(--radius-full);
}

/* Spend Summary Cards */
.spend-cards-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
}

@media (max-width: 1024px) {
    .spend-cards-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 576px) {
    .spend-cards-grid { grid-template-columns: 1fr; }
}

.spend-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    transition: all var(--transition-base);
}

.spend-card:hover {
    border-color: var(--border-accent);
    transform: translateY(-2px);
}

.spend-card-label {
    font-size: 0.8rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-xs);
}

.spend-card-value {
    font-size: 1.75rem;
    font-weight: 700;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.spend-card-value.money {
    color: var(--success);
    -webkit-text-fill-color: var(--success);
}

.spend-card-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: var(--space-xs);
}

/* Grafana Embed */
.grafana-embed-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    min-height: 320px;
}

.grafana-embed-container iframe {
    display: block;
    width: 100%;
}

.grafana-fallback {
    display: none;
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-subtle);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="litellm-container">
    <div class="page-header">
        <h1>‚ö° LiteLLM</h1>
        <p>Model router and proxy management</p>
    </div>

    <!-- Status Overview -->
    <div class="status-overview">
        <!-- Health Status -->
        <div class="status-card">
            <div class="status-icon pending" id="health-icon">
                <span class="indicator-dot pending"></span>
            </div>
            <div class="status-info">
                <h3 id="health-status">Checking...</h3>
                <p>LiteLLM Status</p>
            </div>
        </div>

        <!-- Models Count -->
        <div class="status-card">
            <div class="status-icon" style="background: var(--info-bg);">
                ü§ñ
            </div>
            <div class="status-info">
                <h3 id="models-count">-</h3>
                <p>Available Models</p>
            </div>
        </div>

        <!-- Endpoint -->
        <div class="status-card">
            <div class="status-icon" style="background: rgba(139, 92, 246, 0.15);">
                üåê
            </div>
            <div class="status-info">
                <h3 style="font-size: 1rem;">{{ service_host }}</h3>
                <p>Endpoint: Port 18793</p>
            </div>
        </div>
    </div>

    <!-- Global Spend Summary -->
    <div class="spend-summary-section" style="margin-bottom: var(--space-xl);">
        <div class="section-header">
            <h2 class="section-title">üí∞ Usage & Spend Summary</h2>
            <button class="btn btn-secondary btn-sm" onclick="loadGlobalSpend()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
            </button>
        </div>
        <div class="spend-cards-grid" id="spend-cards">
            <!-- Loading skeleton -->
            <div class="spend-card skeleton-card">
                <div class="skeleton skeleton-text" style="width: 50%;"></div>
                <div class="skeleton skeleton-text" style="width: 80%; height: 2rem; margin-top: 8px;"></div>
            </div>
            <div class="spend-card skeleton-card">
                <div class="skeleton skeleton-text" style="width: 50%;"></div>
                <div class="skeleton skeleton-text" style="width: 80%; height: 2rem; margin-top: 8px;"></div>
            </div>
            <div class="spend-card skeleton-card">
                <div class="skeleton skeleton-text" style="width: 50%;"></div>
                <div class="skeleton skeleton-text" style="width: 80%; height: 2rem; margin-top: 8px;"></div>
            </div>
            <div class="spend-card skeleton-card">
                <div class="skeleton skeleton-text" style="width: 50%;"></div>
                <div class="skeleton skeleton-text" style="width: 80%; height: 2rem; margin-top: 8px;"></div>
            </div>
        </div>
    </div>

    <!-- Grafana Usage Chart -->
    <div class="grafana-section" style="margin-bottom: var(--space-xl);">
        <div class="section-header">
            <h2 class="section-title">üìà Usage Analytics</h2>
            <a href="https://{{ service_host }}:13000/d/litellm-usage" target="_blank" class="btn btn-secondary btn-sm">
                Open Grafana ‚Üí
            </a>
        </div>
        <div class="grafana-embed-container">
            <iframe 
                src="https://{{ service_host }}:13000/d-solo/litellm-usage/litellm-usage?orgId=1&panelId=1&theme=dark&kiosk"
                width="100%" 
                height="300" 
                frameborder="0"
                title="LiteLLM Usage Chart"
                loading="lazy"
                style="border-radius: var(--radius-lg); background: var(--bg-tertiary);"
            ></iframe>
            <div class="grafana-fallback" id="grafana-fallback" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <p>Grafana dashboard not available</p>
                    <a href="https://{{ service_host }}:13000" target="_blank" class="btn btn-secondary" style="margin-top: 1rem;">
                        Open Grafana Directly ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Models Table -->
    <div class="models-section">
        <div class="section-header">
            <h2 class="section-title">
                ü§ñ Available Models
                <span class="loading-spinner" id="loading-indicator" style="display: none;"></span>
            </h2>
            <button class="btn btn-secondary" onclick="refreshModels()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
            </button>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Model Name</th>
                        <th>Provider</th>
                        <th>Max Tokens</th>
                        <th>Input $/1M</th>
                        <th>Output $/1M</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="models-tbody">
                    <!-- Skeleton rows -->
                    <tr class="skeleton-row">
                        <td><div class="skeleton skeleton-text"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 80px;"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 60px;"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 50px;"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 50px;"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 70px;"></div></td>
                    </tr>
                    <tr class="skeleton-row">
                        <td><div class="skeleton skeleton-text"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 80px;"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 60px;"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 50px;"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 50px;"></div></td>
                        <td><div class="skeleton skeleton-text" style="width: 70px;"></div></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Model Cards -->
    <div class="models-section">
        <div class="section-header">
            <h2 class="section-title">üìä Model Details</h2>
        </div>
        <div class="model-cards-grid" id="model-cards">
            <div class="empty-state">
                <div class="empty-state-icon">üîÑ</div>
                <p>Loading model information...</p>
            </div>
        </div>
    </div>

    <!-- API Endpoints -->
    <div class="endpoints-section">
        <div class="section-header">
            <h2 class="section-title">üîå API Endpoints</h2>
        </div>
        <div class="endpoints-list">
            <div class="endpoint-item">
                <code class="endpoint-url">GET /models</code>
                <span class="endpoint-desc">List available models</span>
                <a href="https://{{ service_host }}/litellm/models" target="_blank" class="btn btn-secondary btn-sm">Open ‚Üí</a>
            </div>
            <div class="endpoint-item">
                <code class="endpoint-url">GET /health</code>
                <span class="endpoint-desc">Check service health</span>
                <a href="https://{{ service_host }}/litellm/health" target="_blank" class="btn btn-secondary btn-sm">Open ‚Üí</a>
            </div>
            <div class="endpoint-item">
                <code class="endpoint-url">POST /chat/completions</code>
                <span class="endpoint-desc">OpenAI-compatible chat endpoint</span>
            </div>
            <div class="endpoint-item highlight">
                <code class="endpoint-url">GET /</code>
                <span class="endpoint-desc">Swagger UI Documentation</span>
                <a href="https://{{ service_host }}/litellm/" target="_blank" class="btn btn-primary btn-sm">Open Swagger ‚Üí</a>
            </div>
        </div>
    </div>

    <!-- Provider Credits/Balances -->
    <div class="credits-section" style="margin-top: var(--space-xl);">
        <div class="section-header">
            <h2 class="section-title">üí∞ Provider Credits & Balances</h2>
            <button class="btn btn-secondary btn-sm" onclick="loadBalances()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
            </button>
        </div>
        <div class="balances-grid" id="balances-grid">
            <div class="balance-card skeleton-card">
                <div class="skeleton skeleton-text" style="width: 60%;"></div>
                <div class="skeleton skeleton-text" style="width: 40%; margin-top: 8px;"></div>
            </div>
            <div class="balance-card skeleton-card">
                <div class="skeleton skeleton-text" style="width: 60%;"></div>
                <div class="skeleton skeleton-text" style="width: 40%; margin-top: 8px;"></div>
            </div>
            <div class="balance-card skeleton-card">
                <div class="skeleton skeleton-text" style="width: 60%;"></div>
                <div class="skeleton skeleton-text" style="width: 40%; margin-top: 8px;"></div>
            </div>
        </div>
    </div>
</div>

<style>
/* Balance Cards */
.balances-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-md);
}

.balance-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    transition: all var(--transition-base);
}

.balance-card:hover {
    border-color: var(--border-accent);
    transform: translateY(-2px);
}

.balance-card.kimi { border-left: 3px solid #ff6b6b; }
.balance-card.openrouter { border-left: 3px solid #6366f1; }
.balance-card.local { border-left: 3px solid var(--success); }

.balance-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.balance-provider {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.balance-status {
    font-size: 0.75rem;
    padding: 4px 8px;
    border-radius: var(--radius-full);
}

.balance-status.ok { background: var(--success-bg); color: var(--success); }
.balance-status.free { background: var(--info-bg); color: var(--info); }
.balance-status.error { background: var(--danger-bg); color: var(--danger); }

.balance-amount {
    font-size: 2rem;
    font-weight: 700;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-xs);
}

.balance-currency {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.balance-details {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
    font-size: 0.8rem;
    color: var(--text-muted);
}

.balance-detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.skeleton-card {
    min-height: 120px;
}
</style>
{% endblock %}

{% block extra_js %}
<script data-page-script>
// Use the FastAPI proxy instead of direct LiteLLM calls (handles auth)
const API_URL = window.ARIA_API_BASE_URL;

// Pricing data per 1M tokens ($ USD) - based on public pricing
const MODEL_PRICING = {
    // Free OpenRouter models
    'google/gemini-2.0-flash-exp:free': { input: 0, output: 0 },
    'deepseek/deepseek-chat-v3-0324:free': { input: 0, output: 0 },
    'meta-llama/llama-3.3-70b-instruct:free': { input: 0, output: 0 },
    'qwen/qwen3-235b-a22b:free': { input: 0, output: 0 },
    'qwen/qwen-2.5-coder-32b-instruct:free': { input: 0, output: 0 },
    // Moonshot/Kimi models (CNY converted to USD ~0.14)
    'moonshot-v1-8k': { input: 1.68, output: 1.68 },
    'moonshot-v1-32k': { input: 3.36, output: 3.36 },
    'moonshot-v1-128k': { input: 8.40, output: 8.40 },
    'moonshot-v1-auto': { input: 1.68, output: 1.68 },
    'kimi-latest': { input: 1.68, output: 1.68 },
    'moonshot-code': { input: 1.68, output: 1.68 },
    'moonshot-reasoning': { input: 5.60, output: 5.60 },
    // Local models
    'local-mlx': { input: 0, output: 0 },
    'local': { input: 0, output: 0 },
    // Fallback defaults by provider
    '_default_openai': { input: 2.50, output: 10.00 },
    '_default_anthropic': { input: 3.00, output: 15.00 },
    '_default_google': { input: 0.075, output: 0.30 },
    '_default_local': { input: 0, output: 0 },
    '_default_kimi': { input: 1.68, output: 1.68 },
    '_default_other': { input: 0.50, output: 1.00 }
};

function getModelPricing(modelId) {
    // Direct lookup first
    if (MODEL_PRICING[modelId]) {
        return MODEL_PRICING[modelId];
    }
    // Fallback by provider
    const provider = getProvider(modelId).toLowerCase();
    return MODEL_PRICING[`_default_${provider}`] || MODEL_PRICING['_default_other'];
}

function formatPrice(price) {
    if (price === 0) return '<span class="price-free">FREE</span>';
    if (price < 0.01) return '$' + price.toFixed(4);
    if (price < 1) return '$' + price.toFixed(3);
    return '$' + price.toFixed(2);
}

// Check health status via API proxy
async function checkHealth() {
    const healthIcon = document.getElementById('health-icon');
    const healthStatus = document.getElementById('health-status');
    
    try {
        const response = await fetch(`${API_URL}/litellm/health`);
        const data = await response.json();
        
        if (data.status === 'healthy') {
            healthStatus.textContent = 'Online';
            healthIcon.className = 'status-icon online';
            healthIcon.innerHTML = '<span class="indicator-dot online"></span>';
        } else {
            throw new Error('Not healthy');
        }
    } catch (error) {
        healthStatus.textContent = 'Offline';
        healthIcon.className = 'status-icon offline';
        healthIcon.innerHTML = '<span class="indicator-dot offline"></span>';
    }
}

// Fetch and display models via API proxy
async function loadModels() {
    const indicator = document.getElementById('loading-indicator');
    indicator.style.display = 'inline-block';
    
    try {
        const response = await fetch(`${API_URL}/litellm/models`);
        const data = await response.json();
        const models = data.data || [];
        
        // Update count
        document.getElementById('models-count').textContent = models.length;
        
        // Render table
        renderModelsTable(models);
        
        // Render cards
        renderModelCards(models);
        
    } catch (error) {
        console.error('Error loading models:', error);
        document.getElementById('models-count').textContent = '?';
        document.getElementById('models-tbody').innerHTML = `
            <tr>
                <td colspan="4">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>Failed to load models. Is LiteLLM running?</p>
                        <button class="btn btn-secondary" onclick="loadModels()" style="margin-top: 1rem;">Retry</button>
                    </div>
                </td>
            </tr>
        `;
        document.getElementById('model-cards').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">‚ö†Ô∏è</div>
                <p>Could not connect to LiteLLM</p>
            </div>
        `;
    } finally {
        indicator.style.display = 'none';
    }
}

// Load provider balances
async function loadBalances() {
    const grid = document.getElementById('balances-grid');
    
    try {
        const response = await fetch(`${API_URL}/providers/balances`);
        const balances = await response.json();
        
        let html = '';
        
        // Kimi balance
        if (balances.kimi) {
            const kimi = balances.kimi;
            if (kimi.status === 'ok') {
                html += `
                    <div class="balance-card kimi">
                        <div class="balance-header">
                            <span class="balance-provider">üåô ${kimi.provider}</span>
                            <span class="balance-status ok">Active</span>
                        </div>
                        <div class="balance-amount">¬•${kimi.available?.toFixed(2) || '0.00'}</div>
                        <div class="balance-currency">Chinese Yuan (CNY)</div>
                        <div class="balance-details">
                            <div class="balance-detail-row">
                                <span>Cash Balance:</span>
                                <span>¬•${kimi.cash?.toFixed(2) || '0.00'}</span>
                            </div>
                            <div class="balance-detail-row">
                                <span>Voucher Balance:</span>
                                <span>¬•${kimi.voucher?.toFixed(2) || '0.00'}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="balance-card kimi">
                        <div class="balance-header">
                            <span class="balance-provider">üåô Moonshot/Kimi</span>
                            <span class="balance-status error">Error</span>
                        </div>
                        <div class="balance-amount">--</div>
                        <div class="balance-currency">Could not fetch balance</div>
                    </div>
                `;
            }
        }
        
        // OpenRouter balance
        if (balances.openrouter) {
            const or = balances.openrouter;
            if (or.status === 'ok') {
                html += `
                    <div class="balance-card openrouter">
                        <div class="balance-header">
                            <span class="balance-provider">üåê ${or.provider}</span>
                            <span class="balance-status ok">Active</span>
                        </div>
                        <div class="balance-amount">$${or.remaining?.toFixed(2) || '0.00'}</div>
                        <div class="balance-currency">US Dollars (USD)</div>
                        <div class="balance-details">
                            <div class="balance-detail-row">
                                <span>Credit Limit:</span>
                                <span>$${or.limit?.toFixed(2) || '0.00'}</span>
                            </div>
                            <div class="balance-detail-row">
                                <span>Used:</span>
                                <span>$${or.usage?.toFixed(2) || '0.00'}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (or.status === 'free_tier') {
                html += `
                    <div class="balance-card openrouter">
                        <div class="balance-header">
                            <span class="balance-provider">üåê OpenRouter</span>
                            <span class="balance-status free">Free Tier</span>
                        </div>
                        <div class="balance-amount">FREE</div>
                        <div class="balance-currency">${or.note}</div>
                    </div>
                `;
            }
        }
        
        // Local models
        if (balances.local) {
            html += `
                <div class="balance-card local">
                    <div class="balance-header">
                        <span class="balance-provider">üñ•Ô∏è ${balances.local.provider}</span>
                        <span class="balance-status free">Free</span>
                    </div>
                    <div class="balance-amount">$0.00</div>
                    <div class="balance-currency">${balances.local.note}</div>
                </div>
            `;
        }
        
        grid.innerHTML = html || '<div class="empty-state"><p>No provider information available</p></div>';
        
    } catch (error) {
        console.error('Error loading balances:', error);
        grid.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">‚ö†Ô∏è</div>
                <p>Could not load provider balances</p>
            </div>
        `;
    }
}

// Load global spend summary
async function loadGlobalSpend() {
    const container = document.getElementById('spend-cards');
    
    try {
        const response = await fetch(`${API_URL}/litellm/global-spend`);
        const data = await response.json();
        
        // Calculate totals
        const totalSpend = data.spend || 0;
        const totalTokens = data.total_tokens || 0;
        const inputTokens = data.input_tokens || 0;
        const outputTokens = data.output_tokens || 0;
        const requestCount = data.api_requests || 0;
        
        container.innerHTML = `
            <div class="spend-card">
                <div class="spend-card-label">Total Spend</div>
                <div class="spend-card-value money">$${totalSpend.toFixed(4)}</div>
                <div class="spend-card-subtitle">All-time API costs</div>
            </div>
            <div class="spend-card">
                <div class="spend-card-label">Total Tokens</div>
                <div class="spend-card-value">${formatLargeNumber(totalTokens)}</div>
                <div class="spend-card-subtitle">${formatLargeNumber(inputTokens)} in / ${formatLargeNumber(outputTokens)} out</div>
            </div>
            <div class="spend-card">
                <div class="spend-card-label">API Requests</div>
                <div class="spend-card-value">${formatLargeNumber(requestCount)}</div>
                <div class="spend-card-subtitle">Total completions</div>
            </div>
            <div class="spend-card">
                <div class="spend-card-label">Avg Cost/Request</div>
                <div class="spend-card-value money">${requestCount > 0 ? '$' + (totalSpend / requestCount).toFixed(6) : '$0.00'}</div>
                <div class="spend-card-subtitle">Per API call</div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading global spend:', error);
        container.innerHTML = `
            <div class="spend-card" style="grid-column: span 4;">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <p>Spend tracking not available (LiteLLM DB may not be configured)</p>
                </div>
            </div>
        `;
    }
}

function formatLargeNumber(num) {
    if (num === null || num === undefined) return '0';
    const n = parseInt(num);
    if (isNaN(n)) return '0';
    if (n >= 1000000000) return (n / 1000000000).toFixed(2) + 'B';
    if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
    return n.toString();
}

function renderModelsTable(models) {
    const tbody = document.getElementById('models-tbody');
    
    if (models.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No models configured</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = models.map(model => {
        const provider = getProvider(model.id);
        const maxTokens = model.max_tokens || model.context_length || '-';
        const pricing = getModelPricing(model.id);
        
        return `
            <tr>
                <td><span class="model-name">${escapeHtml(model.id)}</span></td>
                <td><span class="provider-badge provider-${provider.toLowerCase()}">${provider}</span></td>
                <td>${formatNumber(maxTokens)}</td>
                <td class="price-cell">${formatPrice(pricing.input)}</td>
                <td class="price-cell">${formatPrice(pricing.output)}</td>
                <td><span class="status-badge available">Available</span></td>
            </tr>
        `;
    }).join('');
}

function renderModelCards(models) {
    const container = document.getElementById('model-cards');
    
    if (models.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <p>No models to display</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = models.slice(0, 9).map(model => {
        const provider = getProvider(model.id);
        const maxTokens = model.max_tokens || model.context_length || 'Unknown';
        const pricing = getModelPricing(model.id);
        
        return `
            <div class="model-card">
                <div class="model-card-header">
                    <span class="model-card-name">${escapeHtml(model.id)}</span>
                    <span class="provider-badge provider-${provider.toLowerCase()}">${provider}</span>
                </div>
                <div class="model-card-stats">
                    <div class="model-card-stat">
                        <span>Max Tokens:</span>
                        <span>${formatNumber(maxTokens)}</span>
                    </div>
                    <div class="model-card-stat">
                        <span>Input $/1M:</span>
                        <span>${formatPrice(pricing.input)}</span>
                    </div>
                    <div class="model-card-stat">
                        <span>Output $/1M:</span>
                        <span>${formatPrice(pricing.output)}</span>
                    </div>
                    ${model.owned_by ? `
                    <div class="model-card-stat">
                        <span>Owner:</span>
                        <span>${escapeHtml(model.owned_by)}</span>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function getProvider(modelId) {
    const id = modelId.toLowerCase();
    if (id.includes('gpt') || id.includes('openai') || id.includes('o1') || id.includes('o3')) return 'OpenAI';
    if (id.includes('claude') || id.includes('anthropic')) return 'Anthropic';
    if (id.includes('gemini') || id.includes('google') || id.includes('palm')) return 'Google';
    if (id.includes('mlx') || id.includes('llama') || id.includes('mistral') || id.includes('local') || id.includes('qwen') || id.includes('glm')) return 'Local';
    if (id.includes('kimi') || id.includes('moonshot')) return 'Kimi';
    return 'Other';
}

function formatNumber(num) {
    if (num === '-' || num === 'Unknown') return num;
    const n = parseInt(num);
    if (isNaN(n)) return num;
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
    return n.toString();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function refreshModels() {
    checkHealth();
    loadModels();
    loadBalances();
    loadGlobalSpend();
}

// Initial load
checkHealth();
loadModels();
loadBalances();
loadGlobalSpend();

// Refresh every 60 seconds
setInterval(() => {
    checkHealth();
    loadModels();
    loadBalances();
    loadGlobalSpend();
}, 60000);
</script>
{% endblock %}
